# åŠ è½½æ‰€éœ€åŒ…
library(DESeq2)
library(biomaRt)
library(clusterProfiler)
library(enrichplot)
library(org.Mm.eg.db)   # å°é¼ æ³¨é‡Šæ•°æ®åº“
library(ggplot2)

# -----------------------------
# 1. è·å–å·®å¼‚åŸºå› ï¼ˆæ”¾å®½ç­›é€‰ï¼‰
# -----------------------------
# å‡è®¾ res æ˜¯ DESeq2 çš„ç»“æœæ•°æ®æ¡†ï¼ˆåŒ…å« padj å’Œ log2FoldChangeï¼‰
significant_genes <- subset(res, padj < 0.1 & abs(log2FoldChange) > 0.58)
sig_gene_ids <- rownames(significant_genes)
print(paste("æ˜¾è‘—å·®å¼‚åŸºå› æ•°é‡:", length(sig_gene_ids)))

# -----------------------------
# 2. ä½¿ç”¨ biomaRt è½¬æ¢ Ensembl ID â†’ Entrez ID
# -----------------------------
mart <- useMart("ensembl", dataset = "mmusculus_gene_ensembl")

converted <- getBM(
  attributes = c("ensembl_gene_id", "external_gene_name", "entrezgene_id"),
  filters = "ensembl_gene_id",
  values = sig_gene_ids,
  mart = mart
)

entrez_ids <- na.omit(converted$entrezgene_id)
print(paste("æˆåŠŸè½¬æ¢ä¸º Entrez ID çš„æ•°é‡:", length(entrez_ids)))

# -----------------------------
# 3. è·å–èƒŒæ™¯åŸºå› ï¼ˆç”¨äºå¯Œé›†åˆ†æä¸­çš„ universeï¼‰
# -----------------------------
background_entrez <- keys(org.Mm.eg.db, keytype = "ENTREZID")
print(paste("èƒŒæ™¯åŸºå› æ•°é‡ï¼ˆEntrez IDï¼‰:", length(background_entrez)))

# -----------------------------
# 4. è¿›è¡Œ KEGG å¯Œé›†åˆ†æï¼ˆä½¿ç”¨ Entrez IDï¼‰
# -----------------------------
if (length(entrez_ids) > 5) {
  kk <- enrichKEGG(
    gene         = entrez_ids,
    organism     = 'mmu',
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.05
  )
  
  print(kk)
  
  if (!is.null(kk@result)) {
    
    dir.create("KEGG_plots", showWarnings = FALSE)
    
    # Dot plot - æ›´å¤šè°ƒæ•´ï¼šå¢åŠ å®½åº¦ + å­—ä½“ç¼©å° + æ ‡ç­¾æ—‹è½¬
    dot_plot <- dotplot(kk, showCategory = 10) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
        axis.title = element_text(size = 8),
        legend.position = "right"
      ) +
      labs(title = "Dot Plot (Top 10 enriched pathways)")
    
    print(dot_plot)
    ggsave("KEGG_plots/dotplot.png", plot = dot_plot, width = 14, height = 8, dpi = 300)
    
    # Bar plot - æ¨ªå‘æ¡å½¢å›¾ + å‚ç›´æ—‹è½¬æ ‡ç­¾
    bar_plot <- barplot(kk, showCategory = 10) +
      theme(
        axis.text.y = element_text(size = 6),  # y è½´æ–‡æœ¬
        axis.title = element_text(size = 8),
        legend.position = "bottom"
      ) +
      labs(title = "Bar Plot (Top 10 enriched pathways)")
    
    print(bar_plot)
    ggsave("KEGG_plots/barplot.png", plot = bar_plot, width = 14, height = 8, dpi = 300)
    
    # Cnet plot - å¯è§†åŒ–é€šè·¯ä¸åŸºå› å…³ç³»
    gene_logfc <- setNames(significant_genes$log2FoldChange, converted$entrezgene_id[match(sig_gene_ids, converted$ensembl_gene_id)])
    
    cnet_plot <- cnetplot(kk, showCategory = 15, foldChange = gene_logfc) +
      theme(
        axis.text = element_text(size = 8),
        plot.title = element_text(size = 10)
      )
    
    print(cnet_plot)
    ggsave("KEGG_plots/cnetplot.png", plot = cnet_plot, width = 14, height = 10, dpi = 300)
    
    # ä¿å­˜ç»“æœ
    write.csv(kk@result, "KEGG_enrichment_results.csv", row.names = FALSE)
    cat("âœ… KEGG åˆ†æç»“æœå·²ä¿å­˜åˆ° KEGG_enrichment_results.csv\n")
    cat("ğŸ“Š å¯è§†åŒ–å›¾è¡¨å·²ä¿å­˜åˆ° KEGG_plots/ ç›®å½•ä¸‹\n")
    
  } else {
    cat("âš ï¸ æ²¡æœ‰æ˜¾è‘—å¯Œé›†çš„ KEGG é€šè·¯ï¼Œè¯·å°è¯•è¿›ä¸€æ­¥æ”¾å®½ç­›é€‰\n")
  }
} else {
  cat("âŒ Entrez ID æ•°é‡å¤ªå°‘ï¼Œæ— æ³•è¿›è¡Œ KEGG å¯Œé›†åˆ†æ\n")
}

# -----------------------------
# 5. è¿›è¡Œ GO å¯Œé›†åˆ†æï¼ˆBP/MF/CCï¼‰
# -----------------------------
go_types <- c("BP", "MF", "CC")  # ç”Ÿç‰©å­¦è¿‡ç¨‹ã€åˆ†å­åŠŸèƒ½ã€ç»†èƒç»„åˆ†

dir.create("GO_plots", showWarnings = FALSE)

for (ont in go_types) {
  
  ego <- enrichGO(
    gene         = entrez_ids,
    OrgDb        = org.Mm.eg.db,
    ont          = ont,
    pvalueCutoff = 0.05,
    qvalueCutoff = 0.05,
    universe     = background_entrez
  )
  
  print(ego)
  
  if (!is.null(ego@result)) {
    
    # æ„å»ºæ–‡ä»¶å
    result_file <- paste0("GO_", ont, "_results.csv")
    dot_plot_file <- paste0("GO_plots/dotplot_GO_", ont, ".png")
    bar_plot_file <- paste0("GO_plots/barplot_GO_", ont, ".png")
    cnet_plot_file <- paste0("GO_plots/cnetplot_GO_", ont, ".png")
    
    # Dot plot
    dot_plot_go <- dotplot(ego, showCategory = 10) +
      theme(
        axis.text.x = element_text(angle = 45, hjust = 1, size = 6),
        axis.title = element_text(size = 8),
        legend.position = "right"
      ) +
      labs(title = paste("Dot Plot (Top 10 enriched GO", ont, ")"))
    
    print(dot_plot_go)
    ggsave(dot_plot_file, plot = dot_plot_go, width = 14, height = 8, dpi = 300)
    
    # Bar plot
    bar_plot_go <- barplot(ego, showCategory = 10) +
      theme(
        axis.text.y = element_text(size = 6),
        axis.title = element_text(size = 8),
        legend.position = "bottom"
      ) +
      labs(title = paste("Bar Plot (Top 10 enriched GO", ont, ")"))
    
    print(bar_plot_go)
    ggsave(bar_plot_file, plot = bar_plot_go, width = 14, height = 8, dpi = 300)
    
    # Cnet plot
    gene_logfc_go <- setNames(significant_genes$log2FoldChange, converted$entrezgene_id[match(sig_gene_ids, converted$ensembl_gene_id)])
    
    cnet_plot_go <- cnetplot(ego, showCategory = 15, foldChange = gene_logfc_go) +
      theme(
        axis.text = element_text(size = 8),
        plot.title = element_text(size = 10)
      )
    
    print(cnet_plot_go)
    ggsave(cnet_plot_file, plot = cnet_plot_go, width = 14, height = 10, dpi = 300)
    
    # ä¿å­˜ç»“æœ
    write.csv(ego@result, result_file, row.names = FALSE)
    cat(paste0("âœ… GO(", ont, ") åˆ†æç»“æœå·²ä¿å­˜åˆ° ", result_file, "\n"))
    cat(paste0("ğŸ“Š GO(", ont, ") å›¾è¡¨å·²ä¿å­˜åˆ° GO_plots/ ç›®å½•ä¸‹\n"))
    
  } else {
    cat(paste0("âš ï¸ æ²¡æœ‰æ˜¾è‘—å¯Œé›†çš„ GO(", ont, ") termï¼Œè¯·å°è¯•è¿›ä¸€æ­¥æ”¾å®½ç­›é€‰æ¡ä»¶\n"))
  }
}
